<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Historical Markers Map – Encyclopedia of Philippine Heritage</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,600,600i,700|Merriweather:300,300i" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.0.6/dist/MarkerCluster.css" />
<link rel="stylesheet" href="css/leaflet.extra-markers.min.css" />
<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.0.6/dist/leaflet.markercluster.js"></script>
<script src="js/leaflet.extra-markers.min.js"></script>
<style>

html, body {
  margin: 0;
  padding: 0;
  height: 100%;
}

body {
  display: flex;
  align-items: stretch;
}

.loader {
  border-radius: 50%;
  width: 40px;
  height: 40px;
  font-size: 10px;
  text-indent: -9999em;
  border-top: 5px solid rgba(34, 102, 136, 0.2);
  border-right: 5px solid rgba(34, 102, 136, 0.2);
  border-bottom: 5px solid rgba(34, 102, 136, 0.2);
  border-left: 5px solid #268;
  transform: translateZ(0);
  animation: load8 1.1s infinite linear;
}

@keyframes load8 {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

#panel {
  display: flex;
  flex-direction: column;
  flex: 0 1 500px;
  height: 100%;
  background: #268;
}

#branding {
  font-family: "Open Sans", sans-serif;
  -moz-user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
}

#branding p {
  margin: 20px 20px 0;
  padding: 0;
  font-size: 12px;
  line-height: 12px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: #598ca6;
}

#branding h1 {
  margin: 5px 20px 15px;
  padding: 0;
  font-size: 24px;
  font-weight: 600;
  line-height: 24px;
  color: #fff;
}

nav ul {
  list-style: none;
  margin: 0 20px;
  padding: 0;
  -moz-user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
}

nav li {
  display: inline-block;
  margin: 0;
  padding: 0;
}

nav li a {
  display: block;
  position: relative;
  margin: 0 12px 0 0;
  padding: 6px 12px 6px 16px;
  font-size: 12px;
  line-height: 12px;
  font-family: "Open Sans", sans-serif;
  font-weight: 700;
  border-radius: 6px 6px 0 0;
  background: #598ca6;
  color: #046;
  text-decoration: none;
  text-transform: uppercase;
  transition-property: background;
  transition-duration: 0.3s;
}

nav li a:hover {
  background: #90b2c4;
}

nav li a::after {
  content: '';
  display: inline-block;
  position: absolute;
  top: 0; right: -8px;
  width: 15px;
  height: 24px;
  border-radius: 0 6px 0 0;
  background: inherit;
  transform: skew(30deg);
}

nav li.selected a {
  background: #fff;
}

#init {
  flex: 1;
  margin: 0 0 20px 0;
  padding: 20px;
  background: #fff;
}

#init .loader {
  margin: 20px auto;
}

.panel-content {
  flex: 1;
  margin: 0 0 20px 0;
  overflow-y: auto;
  background: #fff;
}

#index {
  display: none;
  flex-direction: column;
  font-family: "Open Sans", sans-serif;
  -moz-user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
}

#index header {
  padding: 20px 20px 10px;
}

#index header p {
  margin: 0;
  color: #444;
  font-size: 12px;
  line-height: 12px;
  font-weight: 400;
}

#sort {
  margin-top: 10px;
  padding: 6px 12px;
  width: 250px;
  border-radius: 25px;
  border: none;
  font-size: 12px;
  line-height: 12px;
  font-weight: 700;
  text-align: center;
  text-transform: uppercase;
  background: #268;
  color: #cde;
  cursor: pointer;
  transition-property: background, color;
  transition-duration: 0.3s;
}
#sort::-moz-focus-inner { border: none; }
#sort:hover {
  color: #fff;
  background: #598ca6;
}

#marker-list {
  list-style: none;
  flex: 1;
  overflow-y: auto;
  margin: 0;
  padding: 10px 0;
  background: #e9f0f3;
}

#marker-list li {
  margin: 0;
  padding: 0;
  transition-property: background, box-shadow;
  transition-duration: 0.3s;
}
#marker-list li:hover {
  background: #ade;
  box-shadow: 0 -1px #ade;
}

#marker-list li a {
  display: block;
  margin: 0 20px;
  padding: 5px 0;
  border-bottom: 1px solid #ade;
  font-size: 12.5px;
  line-height: 22px;
  font-weight: 400;
  text-decoration: none;
  color: #000;
}

#marker-list li:last-child a {
  border-bottom: none;
}

#details {
  display: none;
  padding: 20px;
}

#details .main-wikidata-link {
  display: block;
  float: right;
  margin: 0 0 0 20px;
}

#details h1 {
  margin: 0 0 20px;
  padding: 0 0 10px;
  font-size: 24px;
  line-height: 24px;
  font-family: "Open Sans", sans-serif;
  font-weight: 600;
  border-bottom: 1px solid #ade;
  color: #134;
}

#details h1 .subtitle {
  font-size: 0.75em;
}
#details h1 .subtitle::before {
  content: '\a';
  white-space: pre;
}

#details h1.untitled {
  font-style: italic;
}

#details p, #details li {
  font-size: 12.5px;
  line-height: 22px;
  font-family: Merriweather, serif;
}

#details p {
  margin: 0 0 10px 0;
  padding: 0;
}

#details ul {
  margin: 0 0 0 24px;
  padding: 0;
}

#details ul li {
  margin: 0 0 5px 0;
  padding: 0;
  list-style: square;
}

#details figure {
  float: right;
  margin: 0 0 20px 0;
  padding: 0;
  width: 156px;
  font-size: 13px;
  line-height: 20px;
  font-family: Merriweather, serif;
  background: #eee;
  transition-property: height;
  transition-duration: 0.5s;
}

#details figure .loader {
  margin: 20px auto;
}

#details figure.nodata {
  height: 100px;
  line-height: 100px;
  text-align: center;
  font-style: italic;
  color: #888;
}

#details figure > a {
  display: block;
  padding: 2px;
  border: 1px solid #ade;
  text-decoration: none;
}

#details figure img {
  display: block;
}

#details figcaption {
  display: block;
  padding: 5px 0 0 0;
  font-size: 10px;
  line-height: 18px;
  color: #888;
  background: #fff;
  font-family: "Open Sans", sans-serif;
  font-weight: 400;
}

#details figcaption a {
  border-bottom: 1px dotted #ccc;
  text-decoration: none;
  color: #888;
}
#details figcaption a:hover {
  background: #eee;
  border-bottom: 1px solid #eee;
}

#details .inscription {
  padding: 0 170px 0 0;
}

#details .inscription.loading {
  margin: 40px 0;
}

#details .inscription .loader {
  margin: 0 auto;
}

#details .inscription.nodata {
  font-style: italic;
  color: #888;
}

#details .inscription p:first-child {
  margin-top: -5px;
}

#details h2 {
  margin: 0 0 5px 0;
  font-size: 12px;
  line-height: 12px;
  font-family: "Open Sans", sans-serif;
  font-weight: 700;
  letter-spacing: 0.5px;
  text-transform: uppercase;
  color: #8bd;
}

#details h2 {
  clear: right;
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid #ade;
}

#details p+h2 {
  margin-top: 15px;
}

#details p.nodata {
  font-style: italic;
  color: #888;
}

#details p a.image, #details li a.image {
  display: inline-block;
  border: none;
  margin-left: 10px;
}

#details p a.image img, #details li a.image img {
  vertical-align: middle;
}

#details p.address {
  padding: 0 170px 0 0;
}

#details .vicinity {
  clear: right;
}

#details .vicinity p {
  padding: 0 170px 0 0;
  font-style: italic;
}

#about {
  display: none;
  padding: 20px;
}

#about #eph {
  float: right;
  margin: 0 0 10px 10px;
}

#about p {
  margin: 0 0 10px 0;
  padding: 0;
  font-size: 12.5px;
  line-height: 22px;
  font-family: Merriweather, serif;
}

#about p a {
  border-bottom: 1px dotted #ccc;
  text-decoration: none;
  color: #666;
}
#about p a:hover {
  border-bottom: 1px solid #eee;
  background: #eee;
}

#map {
  flex: 1;
}

.marker-cluster {
  background-clip: padding-box;
  border-radius: 20px;
}

.marker-cluster div {
  margin: 5px 0 0 5px;
  width: 30px;
  height: 30px;
  text-align: center;
  border-radius: 15px;
  font: 12px "Open Sans", sans-serif;
  font-weight: bold;
}

.marker-cluster span {
  line-height: 30px;
  color: #fff;
}

.marker-cluster-small      { background-color: rgba(68, 153, 204, 0.5); }
.marker-cluster-small  div { background-color: rgba(68, 153, 204, 0.8); }
.marker-cluster-medium     { background-color: rgba(51, 128, 170, 0.5); }
.marker-cluster-medium div { background-color: rgba(51, 128, 170, 0.8); }
.marker-cluster-large      { background-color: rgba(34, 102, 136, 0.5); }
.marker-cluster-large  div { background-color: rgba(34, 102, 136, 0.8); }

.leaflet-popup-content-wrapper, .leaflet-popup-tip {
  background: #268;
  user-select: none;
  -moz-user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
}

.leaflet-popup-content {
  font: 600 18px/20px "Open Sans", sans-serif;
  text-transform: uppercase;
  color: white;
  text-align: center;
}

.leaflet-popup-content .subtitle {
  padding: 2px 0 0;
  font-size: 12px;
  line-height: 16px;
  font-weight: 700;
}

/* Match Leaflet's control style */
.powered {
  line-height: 0.5;
  background: #fff;
  box-shadow: 0 1px 5px rgba(0,0,0,0.65);
  border-radius: 4px;
  overflow: hidden;
}

</style>
</head>
<body>
<section id="panel">
  <header id="branding" role="banner">
    <p>Encyclopedia of Philippine Heritage</p>
    <h1>Historical Markers Map</h1>
  </header>
  <nav>
    <ul>
      <li><a href="#index">Index</a></li>
      <li><a href="#about">About</a></li>
    </ul>
  </nav>
  <div id="init"><div class="loader"></div></div>
  <section id="index" class="panel-content" data-display="flex">
    <header>
      <p id="stats"></p>
      <button id="sort"></button>
    </header>
    <ol id="marker-list"></ol>
  </section>
  <section id="details" class="panel-content" data-display="block">
  </section>
  <aside id="about" class="panel-content" data-display="block">
    <section>
      <p>This <b>Historical Markers Map</b> shows the location of historical markers that have been installed by the
        <a href="https://en.wikipedia.org/wiki/National_Historical_Commission_of_the_Philippines">National Historical
        Commission of the Philippines</a> and its predecessor agencies. Each historical marker is represented by a map
        marker that when clicked provides more information about the historical marker, including a photo of the marker
        and its encoded inscription.</p>
      <img id="eph" src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/Encyclopedia_of_Philippine_Heritage_logo.svg/125px-Encyclopedia_of_Philippine_Heritage_logo.svg.png" alt="Encyclopedia of Philippine Heritage">
      <p>The data on these historical markers comes from <a href="https://www.wikidata.org/">Wikidata</a>, a sister
        project of Wikipedia, and is compiled as part of the <i><b>Encyclopedia of Philippine Heritage</b></i>, a
        program of <a href="http://www.wikimedia.org.ph/">Wikimedia Philippines</a>. If you want to help add and
        improve the data, please refer to this <a href="https://www.wikidata.org/wiki/Wikidata:WikiProject_Philippine_historical_markers">WikiProject
        page</a>.</p>
      <p>If you are familiar with the Wikidata Query Service and want to obtain or explore the raw data, please refer
        to this <a href="#" id="wdqs-link">query</a>.</p>
      <p>To report bugs, suggest improvements, or see the source code of this map app, please refer to this app’s
        <a href="https://github.com/WMPH/eph-historical-markers-map">GitHub repository</a>.</p>
    </section>
    <footer>
      <a href="https://www.wikidata.org/"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/66/Wikidata-logo-en.svg/85px-Wikidata-logo-en.svg.png" alt="[Wikidata]"></a>
      <a href="http://www.wikimedia.org.ph/"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a5/Wikimedia_Philippines.svg/60px-Wikimedia_Philippines.svg.png" alt="[Wikimedia Philippines]"></a>
    </footer>
  </aside>
</section>
<section id="map">
</section>
<script>
'use strict';

// Constants and fixed parameters
const BASE_TITLE = 'Historical Markers Map – Encyclopedia of Philippine Heritage';
const MONTH_NAMES = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
const LANGUAGES = {
  'en': { name: 'English', qid: 'Q1860'  },
  'tl': { name: 'Tagalog', qid: 'Q34057' },
  'es': { name: 'Spanish', qid: 'Q1321'  },
  'de': { name: 'German' , qid: 'Q188'   },
  'fr': { name: 'French' , qid: 'Q150'   },
};
const ORDERED_LANGUAGES = ['en', 'tl', 'es', 'de', 'fr'];
const NL = '\n';
const SPARQL_QUERY =
'SELECT ?marker ?markerLabel ?coord ?title ?subtitle ?titleNoValue ?image' + NL +
'       ?date ?datePrecision ?inscription ?inscriptionNoValue' + NL +
'       ?country ?countryLabel ?locationLabel ?locationImage ?streetAddress' + NL +
'       ?admin0Label ?admin0Type ?admin1Label ?admin1Type' + NL +
'       ?admin2Label ?admin2Type ?admin3Label ?admin3Type' + NL +
'       ?vicinityImage ?vicinityDescription' + NL +
'       ?commemorates ?commemoratesLabel ?commemoratesArticle WHERE {' + NL +
'  ?marker wdt:P31 wd:Q21562164 ;' + NL +
'          wdt:P625 ?coord .' + NL +
'  OPTIONAL {' + NL +
'    ?marker p:P1476 ?titleStatement .' + NL +
'    OPTIONAL {' + NL +
'      ?titleStatement ps:P1476 ?title .' + NL +
'      OPTIONAL { ?titleStatement pq:P1680 ?subtitle }' + NL +
'    }' + NL +
'    OPTIONAL {' + NL +
'      ?titleStatement a ?titleNoValue .' + NL +
'      FILTER (?titleNoValue = wdno:P1476)' + NL +
'    }' + NL +
'  }' + NL +
'  OPTIONAL {' + NL +
'    ?marker p:P18 ?imageStatement .' + NL +
'    OPTIONAL {' + NL +
'      ?imageStatement ps:P18 ?image .' + NL +
'      FILTER NOT EXISTS { ?imageStatement pq:P3831 wd:Q16968816 }' + NL +
'    }' + NL +
'    OPTIONAL {' + NL +
'      ?imageStatement ps:P18 ?vicinityImage .' + NL +
'      OPTIONAL { ?imageStatement pq:P2096 ?vicinityDescription }' + NL +
'      FILTER EXISTS { ?imageStatement pq:P3831 wd:Q16968816 }' + NL +
'    }' + NL +
'  }' + NL +
'  OPTIONAL {' + NL +
'    ?marker p:P571 ?dateStatement .' + NL +
'    ?dateStatement psv:P571 ?dateValue .' + NL +
'    ?dateValue wikibase:timeValue ?date .' + NL +
'    ?dateValue wikibase:timePrecision ?datePrecision .' + NL +
'  }' + NL +
'  OPTIONAL { ?marker wdt:P1684 ?inscription }' + NL +
'  OPTIONAL {' + NL +
'    ?marker p:P1684 ?inscriptionStatement .' + NL +
'    ?inscriptionStatement a ?inscriptionNoValue .' + NL +
'    FILTER (?inscriptionNoValue = wdno:P1684)' + NL +
'  }' + NL +
'  OPTIONAL { ?marker wdt:P17 ?country }' + NL +
'  OPTIONAL {' + NL +
'    ?marker wdt:P276 ?location .' + NL +
'    OPTIONAL { ?location wdt:P18 ?locationImage }' + NL +
'  }' + NL +
'  OPTIONAL { ?marker wdt:P969 ?streetAddress }' + NL +
'  OPTIONAL {' + NL +
'    ?marker wdt:P131 ?admin0 .' + NL +
'    OPTIONAL {' + NL +
'      ?admin0 wdt:P31 ?admin0Type .' + NL +
'      FILTER (' + NL +
'        ?admin0Type = wd:Q6256   ||' + NL +
'        ?admin0Type = wd:Q24698  ||' + NL +
'        ?admin0Type = wd:Q24746  ||' + NL +
'        ?admin0Type = wd:Q104157 ||' + NL +
'        ?admin0Type = wd:Q29946056' + NL +
'      )' + NL +
'    }' + NL +
'    OPTIONAL {' + NL +
'      ?admin0 wdt:P131 ?admin1 .' + NL +
'      OPTIONAL {' + NL +
'        ?admin1 wdt:P31 ?admin1Type .' + NL +
'        FILTER (' + NL +
'          ?admin1Type = wd:Q6256   ||' + NL +
'          ?admin1Type = wd:Q24698  ||' + NL +
'          ?admin1Type = wd:Q24746  ||' + NL +
'          ?admin1Type = wd:Q104157 ||' + NL +
'          ?admin1Type = wd:Q29946056' + NL +
'        )' + NL +
'      }' + NL +
'      OPTIONAL {' + NL +
'        ?admin1 wdt:P131 ?admin2 .' + NL +
'        OPTIONAL {' + NL +
'          ?admin2 wdt:P31 ?admin2Type .' + NL +
'          FILTER (' + NL +
'            ?admin2Type = wd:Q6256   ||' + NL +
'            ?admin2Type = wd:Q24698  ||' + NL +
'            ?admin2Type = wd:Q24746  ||' + NL +
'            ?admin2Type = wd:Q104157 ||' + NL +
'            ?admin2Type = wd:Q29946056' + NL +
'          )' + NL +
'        }' + NL +
'        OPTIONAL {' + NL +
'          ?admin2 wdt:P131 ?admin3 .' + NL +
'          OPTIONAL {' + NL +
'            ?admin3 wdt:P31 ?admin3Type .' + NL +
'            FILTER (' + NL +
'              ?admin3Type = wd:Q6256   ||' + NL +
'              ?admin3Type = wd:Q24698  ||' + NL +
'              ?admin3Type = wd:Q24746  ||' + NL +
'              ?admin3Type = wd:Q104157 ||' + NL +
'              ?admin3Type = wd:Q29946056' + NL +
'            )' + NL +
'          }' + NL +
'        }' + NL +
'      }' + NL +
'    }' + NL +
'  }' + NL +
'  OPTIONAL {' + NL +
'    ?marker wdt:P547 ?commemorates .' + NL +
'    OPTIONAL {' + NL +
'      ?commemoratesArticle schema:about ?commemorates ;' + NL +
'               schema:isPartOf <https://en.wikipedia.org/> .' + NL +
'    }' + NL +
'  }' + NL +
'  SERVICE wikibase:label { bd:serviceParam wikibase:language "en" }' + NL +
'}';
const SPARQL_QUERY_ESCAPED   = escape(SPARQL_QUERY);
const WDQS_API_URL           = 'https://query.wikidata.org/sparql';
const WDQS_GUI_URL           = 'https://query.wikidata.org/#' + SPARQL_QUERY_ESCAPED;
const YEAR_PRECISION         = '9';
const PH_QID                 = 'Q928';
const COUNTRY_QID            = 'Q6256';
const REGION_QID             = 'Q24698';
const PROVINCE_QID           = 'Q24746';
const HUC_QID                = 'Q29946056';
const CITY_QID               = 'Q104157';
const ADMIN_QIDS             = [COUNTRY_QID, REGION_QID, PROVINCE_QID, HUC_QID, CITY_QID];
const ADMIN_LEVELS           = 4;
const TILE_LAYER_URL         = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
const TILE_LAYER_ATTRIBUTION = 'Base map &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>';
const TILE_LAYER_MAX_ZOOM    = 19;
const MIN_PH_LAT             =   4.5;
const MAX_PH_LAT             =  21.0;
const MIN_PH_LON             = 116.5;
const MAX_PH_LON             = 126.5;
const SORT_MODES             = [
  { id: 'alpha', label: 'alphabetically'  },
  { id: 'qid',   label: 'by Wikidata QID' },
];

// Globals
var Markers = {}; // Hash to contain data about the historical markers
var Map;          // Leaflet map object
var Cluster;      // Leaflet map cluster
var CurrentSortModeIdx;
var AppIsInitialized;

// ------------------------------------------------------------

// This initializes the app once the page has been loaded.
function init() {

  initMap();

  // Add Wikidata Query Service GUI URL
  let anchorElem = document.getElementById('wdqs-link');
  anchorElem.href = WDQS_GUI_URL;

  // Query Wikidata
  let xhrObject = new XMLHttpRequest();
  xhrObject.onreadystatechange = processWikidataQuery;
  xhrObject.open('POST', WDQS_API_URL, true);
  xhrObject.overrideMimeType('text/plain');
  xhrObject.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  xhrObject.send('format=json&query=' + SPARQL_QUERY_ESCAPED);

  window.addEventListener('hashchange', processHashChange);
}


// This initializes the Leaflet-based map.
function initMap() {

  // Create map and set initial view
  Map = new L.map('map');
  Map.fitBounds([[MAX_PH_LAT, MAX_PH_LON], [MIN_PH_LAT, MIN_PH_LON]]);

  // Add specified tile layer
  new L.tileLayer(TILE_LAYER_URL, {
    attribution : TILE_LAYER_ATTRIBUTION,
    maxZoom     : TILE_LAYER_MAX_ZOOM,
  }).addTo(Map);

  // Add powered by Wikidata map control
  let powered = L.control({ position: 'bottomleft' });
  powered.onAdd = function(Map) {
    var divElem = L.DomUtil.create('div', 'powered');
    divElem.innerHTML =
      '<a href="https://www.wikidata.org/"><img src="img/powered_by_wikidata.png"></a>';
    return divElem;
  };
  powered.addTo(Map);

  // Initialize the map marker cluster
  Cluster = new L.markerClusterGroup({
    maxClusterRadius: function(z) {
      if (z <= 15) return 50;
      if (z <= 16) return 40;
      if (z == 17) return 30;
      if (z == 18) return 20;
      if (z >= 19) return 10;
    },
  }).addTo(Map);

  // Add event handler
  Map.on('popupopen', function(e) { displayMarkerDetails(e.popup._qid) });
}


// This is the AJAX event handler for the Wikidata query and
// also completes the app initialization.
function processWikidataQuery() {

  if (this.readyState !== this.DONE || this.status !== 200) return;

  var data = JSON.parse(this.responseText);

  // Go through each query result and populate the Markers database
  data.results.bindings.forEach(function(result) {
    let qid = getQid(result.marker);
    if (!(qid in Markers)) Markers[qid] = new MarkerRecord;
    let record = Markers[qid];
    processQueryResult(result, record);
  });

  // Do post-processing
  let initBounds = [[90, 180], [-90, -180]];
  Object.keys(Markers).forEach(function(qid) { postProcessRecord(qid, initBounds) });

  // Update stats
  let numMarkers = Object.keys(Markers).length;
  document.getElementById('stats').innerHTML = 'Showing a total of ' + numMarkers + ' markers';

  // Re-initialize the map view to display the permalinked marker or
  // to fit the Philippine markers
  let fragment = window.location.hash.replace('#', '');
  if (fragment in Markers) {
    let record = Markers[fragment];
    Map.setView([record.lat, record.lon], TILE_LAYER_MAX_ZOOM);
  }
  else {
    Map.fitBounds(new L.LatLngBounds(initBounds[0], initBounds[1]));
  }

  // Enable the index sort button and add click event handler,
  // and perform the initial sort
  let elem = document.getElementById('sort');
  elem.disabled = false;
  elem.addEventListener('click', switchSortMode);
  CurrentSortModeIdx = SORT_MODES.length - 1;
  switchSortMode();

  // Remove the app initialization spinner and activate the hashchange handler
  AppIsInitialized = true;
  document.getElementById('init').remove();
  processHashChange();
}


// This takes a query result and its corresponding record and updates that
// record with any new data provided in the result.
function processQueryResult(result, record) {

  if ('title' in result) {
    record.title[result.title['xml:lang']] = {
      main : result.title.value,
      sub  : ('subtitle' in result) ? result.subtitle.value : null,
    };
  }
  else if ('titleNoValue' in result) {
    record.title = null;
    // ASSUME: All markers have an English label on Wikidata
    let substituteTitle = result.markerLabel.value.replace(/ ?historical marker/i, '');
    record.indexTitle = '[' + substituteTitle + ']';
  }

  if ('inscription' in result) {
    record.inscription[result.inscription['xml:lang']] = formatInscription(result.inscription.value);
  }
  else if ('inscriptionNoValue' in result) {
    record.inscription = null;
  }

  let wktBits = result.coord.value.split(/\(|\)| /);  // Note: format is Point WKT
  record.lat = parseFloat(wktBits[2]);
  record.lon = parseFloat(wktBits[1]);

  if ('image' in result) {
    record.imageFilename = extractImageFilename(result.image);
  }

  if ('date' in result) {
    let dateVal = result.date.value;
    record.datePrecision = result.datePrecision.value;
    if (result.datePrecision.value === YEAR_PRECISION) {
      record.date = dateVal.substr(0, 4);
    }
    else {
      let month = MONTH_NAMES[Number(dateVal.substr(5, 2)) - 1];
      let day   = Number(dateVal.substr(8, 2));
      let year  = dateVal.substr(0, 4);
      record.date = month + ' ' + day + ', ' + year;
    }
  }

  if ('commemorates' in result) {
    record.commemorates[getQid(result.commemorates)] = {
      title  : result.commemoratesLabel.value,
      wp_url : ('commemoratesArticle' in result) ? result.commemoratesArticle.value : null,
    };
  }

  let adminLabels = [], adminTypes = [];
  for (let i = 0; i < ADMIN_LEVELS; i++) {
    let labelProp = 'admin' + i + 'Label';
    if (labelProp in result) adminLabels[i] = result[labelProp].value;
    let typeProp = 'admin' + i + 'Type';
    if (typeProp in result) adminTypes[i] = getQid(result[typeProp]);
  }

  // Construct address
  let address = '';
  if ('locationLabel' in result) {
    address = result.locationLabel.value;
  }
  if ('streetAddress' in result) {
    address += (address ? ', ' : '') + result.streetAddress.value;
  }
  for (let i = 0; i < ADMIN_LEVELS; i++) {
    if (
      adminLabels[i] && adminTypes[i] !== COUNTRY_QID && (i === 0 || (
        adminTypes[i - 1] !== PROVINCE_QID &&
        adminTypes[i - 1] !== REGION_QID && (
          // Don't display the region for HUCs and Cotabato City unless it's
          // Metro Manila
          (adminTypes[i - 1] !== CITY_QID && adminTypes[i - 1] !== HUC_QID) ||
          adminTypes[i] !== REGION_QID ||
          adminLabels[i] === 'Metro Manila'
        )
      ))
    ) {
      address += (address ? ', ' : '') + adminLabels[i];
    }
    else {
      break;
    }
  }
  if ('country' in result && getQid(result.country) !== PH_QID) {
    address += (address ? ', ' : '') + result.countryLabel.value;
  }

  // Deduplicate entities in the address
  address = address.replace(/(^|, )([^, ]*)(?:, \2)+(, |$)/g, '$1$2$3');

  record.location.address = address;

  if ('locationImage' in result) {
    record.location.imageFilename = extractImageFilename(result.locationImage);
  }

  if ('vicinityImage' in result) {
    record.vicinity.imageFilename = extractImageFilename(result.vicinityImage);
    if ('vicinityDescription' in result) {
      record.vicinity.description = result.vicinityDescription.value;
    }
  }
}


// This takes a historical marker QID and the initial bounding box and
// cleans up the corresponding record, generates a map marker and index entry
// for the historical marker, and updates the bounding box as needed.
function postProcessRecord(qid, initBounds) {

  let record = Markers[qid];

  // Clean up record
  if (Object.keys(record.commemorates).length === 0) record.commemorates = null;
  if (!record.vicinity.imageFilename) record.vicinity = null;

  // Generate the map marker popup HTML
  let popupHtml;
  if (record.title && Object.keys(record.title).length > 0) {
    let title = getTranslation(record.title);
    record.indexTitle = title.main;
    popupHtml = title.main;
    if (title.sub) {
      record.indexTitle += (title.sub.substr(0, 1) === '(' ? ' ' : ': ') + title.sub;
      popupHtml += '<div class="subtitle">' + title.sub + '</div>';
    }
  }
  else {
    popupHtml = record.indexTitle;
  }

  // Create a map marker and add to the cluster
  let mapMarker = L.marker([record.lat, record.lon], {
    icon: L.ExtraMarkers.icon({ icon: '', markerColor : 'cyan' })
  });
  mapMarker.bindPopup(popupHtml, { closeButton: false });
  Cluster.addLayer(mapMarker);
  record.mapMarker = mapMarker;
  let popup = mapMarker.getPopup();
  popup._qid = qid;
  record.popup = popup;

  // Create an index entry and add to the index
  let li = document.createElement('li');
  li.innerHTML = '<a href="#' + qid + '">' + record.indexTitle + '</a>';
  document.getElementById('marker-list').appendChild(li);
  record.indexLi = li;

  // Update the bounding box containing all the historical markers in the
  // Philippines
  if (
    MIN_PH_LAT <= record.lat && record.lat <= MAX_PH_LAT &&
    MIN_PH_LON <= record.lon && record.lon <= MAX_PH_LON
  ) {
    initBounds[0][0] = Math.min(record.lat, initBounds[0][0]);
    initBounds[0][1] = Math.min(record.lon, initBounds[0][1]);
    initBounds[1][0] = Math.max(record.lat, initBounds[1][0]);
    initBounds[1][1] = Math.max(record.lon, initBounds[1][1]);
  }
}


// This takes a historical marker QID and updates the map to show the
// corresponding map marker, opens its popup if it isn't open yet, and
// displays the historical marker's details on the side panel.
function activateMarker(qid) {
  displayMarkerDetails(qid);
  let record = Markers[qid];
  Cluster.zoomToShowLayer(record.mapMarker, function() {
    Map.setView([record.lat, record.lon], Map.getZoom());
    if (!record.popup.isOpen()) {
      record.mapMarker.openPopup();
    }
  });
}


// This function displays the historical marker's details on the side panel.
function displayMarkerDetails(qid) {

  let record = Markers[qid];

  window.location.hash = '#' + qid;
  let title = getTranslation(record.title);
  document.title = (title ? title.main : record.indexTitle) + ' – ' + BASE_TITLE;

  if (!record.panelElem) generateMarkerDetails(qid, record);
  displayPanelContent('details');
  let detailsElem = document.querySelector('#details');
  detailsElem.replaceChild(record.panelElem, detailsElem.childNodes[0]);
}


// This generates the details content of a historical marker for the side panel.
function generateMarkerDetails(qid, record) {

  let titleHtml;
  if (record.title) {
    titleHtml = '<h1>';
    let title = getTranslation(record.title);
    titleHtml += title.main;
    if (title.sub) titleHtml += ' <span class="subtitle">' + title.sub + '</span>';
    titleHtml += '</h1>';
  }
  else {
    titleHtml = '<h1 class="untitled">Untitled</h1>';
  }

  let markerFigureHtml;
  if (record.imageFilename) {
    markerFigureHtml = '<figure class="marker"><div class="loader"></div></figure>';
  }
  else {
    markerFigureHtml = '<figure class="marker nodata">No photo available</figure>';
  }

  let inscriptionHtml;
  if (record.inscription) {
    let inscription = getTranslation(record.inscription);
    if (inscription) {
      inscriptionHtml = '<div class="inscription">' + inscription + '</div>';
    }
    else {
      inscriptionHtml = '<div class="inscription loading"><div class="loader"></div></div>';
    }
  }
  else {
    inscriptionHtml = '<div class="inscription nodata"><p>This historical marker has no inscription.</p></div>';
  }

  let commemoratesHtml;
  if (record.commemorates) {
    let commemoratesIds = Object.keys(record.commemorates);
    let tagName = commemoratesIds.length > 1 ? 'li' : 'p';
    commemoratesHtml = commemoratesIds.length > 1 ? '<ul>' : '';
    commemoratesIds.forEach(function(qid) {
      let commemoratesData = record.commemorates[qid];
      commemoratesHtml += '<' + tagName + '>' + commemoratesData.title;
      commemoratesHtml += '<a class="image" href="https://www.wikidata.org/wiki/' + qid + '" title="View in Wikidata">';
      commemoratesHtml += '<img src="img/wikidata_tiny_logo.png" alt="[view Wikidata item]" /></a>';
      if (commemoratesData.wp_url) {
        commemoratesHtml += '<a class="image" href="' + commemoratesData.wp_url + '" title="View in Wikipedia">';
        commemoratesHtml += '<img src="img/wikipedia_tiny_logo.png" alt="[view Wikipedia article]" /></a>';
      }
      commemoratesHtml += '</' + tagName + '>';
    });
    commemoratesHtml += commemoratesIds.length > 1 ? '</ul>' : '';
  }
  else {
    commemoratesHtml = '<p class="nodata">Unspecified</p>';
  }

  let locationFigureHtml = '';
  if (record.location.imageFilename) {
    locationFigureHtml = '<figure class="location"><div class="loader"></div></figure>';
  }

  let addressHtml;
  if (record.location.address) {
    addressHtml = '<p class="address">' + record.location.address + '</p>';
  }
  else {
    addressHtml = '<p class="nodata">Unspecified</p>';
  }

  let vicinityHtml = '';
  if (record.vicinity) {
    vicinityHtml = '<div class="vicinity">';
    vicinityHtml += '<figure class="vicinity"><div class="loader"></div></figure>';
    if (record.vicinity.description) {
      vicinityHtml += '<p>' + record.vicinity.description + '</p>';
    }
    vicinityHtml += '</div>'
  }

  let detailsHtml =
    '<a class="main-wikidata-link" href="https://www.wikidata.org/wiki/' + qid + '" title="View in Wikidata">' +
    '<img src="img/wikidata_tiny_logo.png" alt="[view Wikidata item]" /></a>' +
    titleHtml +
    markerFigureHtml +
    inscriptionHtml +
    '<h2>' + (record.datePrecision === YEAR_PRECISION ? 'Year' : 'Date') + ' installed</h2>' +
    '<p' + (record.date ? ('>' + record.date) : ' class="nodata">Unknown') + '</p>' +
    '<h2>Commemorates</h2>' +
    commemoratesHtml +
    '<h2>Location</h2>' +
    locationFigureHtml +
    addressHtml +
    vicinityHtml;

  let panelElem = document.createElement('div');
  panelElem.innerHTML = detailsHtml;
  record.panelElem = panelElem;

  // Load images
  let markerFigure   = panelElem.querySelector('figure.marker'  );
  let locationFigure = panelElem.querySelector('figure.location');
  let vicinityFigure = panelElem.querySelector('figure.vicinity');
  if (record         .imageFilename) displayFigure(record         .imageFilename, markerFigure  );
  if (record.location.imageFilename) displayFigure(record.location.imageFilename, locationFigure);
  if (record.vicinity              ) displayFigure(record.vicinity.imageFilename, vicinityFigure);

  // Historical marker has no direct inscription: check the talk page
  if (record.inscription && Object.keys(record.inscription).length === 0) {
    checkAndDisplayLongInscription(qid, record);
  }
}


// This takes a historical marker QID and the corresponding record and checks if
// there are {{LongInscription}} templates in the Wikidata talk page. If there
// are, this parses the templates, stores the inscriptions into the record, then
// inserts the preferred inscription into the details content.
function checkAndDisplayLongInscription(qid, record) {
  loadJSONP(
    'https://www.wikidata.org/w/api.php',
    {
      action : 'query',
      format : 'json',
      prop   : 'revisions',
      rvprop : 'content',
      titles : 'Talk:' + qid,
    },
    function(data) {

      // Extract inscriptions and add them to the database
      let pageId = Object.keys(data.query.pages)[0];
      if (pageId !== '-1') {
        let talkContent = data.query.pages[pageId].revisions[0]['*'];
        let templateStrings = talkContent.match(/{{\s*LongInscription[^]+?}}/g);
        if (templateStrings) {
          templateStrings.forEach(function(string) {
            let langQid = string.match(/\|\s*langqid\s*=\s*(Q[0-9]+)/)[1];
            let inscription = string.match(/\|\s*inscription\s*=\s*([^]*?)(?:\||}})/)[1];
            for (let i = 0; i < ORDERED_LANGUAGES.length; i++) {
              let langCode = ORDERED_LANGUAGES[i];
              if (langQid === LANGUAGES[langCode].qid) {
                record.inscription[langCode] = formatInscription(inscription);
                break;
              }
            }
          });
        }
      }

      // Populate the details content with the inscription,
      // or indicate that there's none
      let inscriptionElem = record.panelElem.childNodes[3];
      if (Object.keys(record.inscription).length > 0) {
        inscriptionElem.innerHTML = getTranslation(record.inscription);
      }
      else {
        inscriptionElem.classList.add('nodata');
        inscriptionElem.innerHTML = '<p>No inscription has been encoded yet.</p>';
      }
      inscriptionElem.classList.remove('loading');
    }
  );
}


// This takes a Commons image filename and a figure HTML element and populates
// the element with the 150-pixel wide image and any required attribution inside
// a figcaption element.
function displayFigure(filename, figure) {

  // Fetch the image thumbnail
  loadJSONP(
    'https://commons.wikimedia.org/w/api.php',
    {
      action     : 'query',
      format     : 'json',
      prop       : 'imageinfo',
      iiprop     : 'url',
      iiurlwidth : 150,
      titles     : 'File:' + filename,
    },
    function(data) {
      let pageId = Object.keys(data.query.pages)[0];
      let imageInfo = data.query.pages[pageId].imageinfo[0];
      let img = document.createElement('img');
      img.src = imageInfo.thumburl;
      let anchor = document.createElement('a');
      anchor.href = imageInfo.descriptionurl;
      anchor.style.height = imageInfo.thumbheight + 'px';
      anchor.appendChild(img);
      figure.replaceChild(anchor, figure.childNodes[0]);  // replace spinner
    }
  );

  // Fetch the image attribution and see if it is needed
  loadJSONP(
    'https://commons.wikimedia.org/w/api.php',
    {
      action : 'query',
      format : 'json',
      prop   : 'imageinfo',
      iiprop : 'extmetadata',
      titles : 'File:' + filename,
    },
    function(data) {
      let pageId = Object.keys(data.query.pages)[0];
      let metadata = data.query.pages[pageId].imageinfo[0].extmetadata;
      let artistHtml = metadata.Artist.value;
      if (artistHtml.search('href="//') >= 0) {
        artistHtml = artistHtml.replace(/href="(?:https?:)?\/\//, 'href="https://');
      }
      let licenseHtml = '';
      if ('AttributionRequired' in metadata && metadata.AttributionRequired.value === 'true') {
        licenseHtml = metadata.LicenseShortName.value.replace(/ /g, '&nbsp;');
        if ('LicenseUrl' in metadata) {
          licenseHtml = '<a href="' + metadata.LicenseUrl.value + '">' + licenseHtml + '</a>';
        }
        licenseHtml = '<br>' + licenseHtml;
      }
      figure.insertAdjacentHTML('beforeend', '<figcaption>' + artistHtml + licenseHtml + '</figcaption>');
    }
  );
}


// This event handler handles any change in the window URL hash
function processHashChange() {

  if (!AppIsInitialized) return;

  let fragment = window.location.hash.replace('#', '');
  if (fragment in Markers) {
    activateMarker(fragment);
  }
  else if (fragment === 'about') {
    document.title = 'About – ' + BASE_TITLE;
    displayPanelContent('about');
  }
  else {
    window.location.hash = '';  // Disable invalid fragments
    document.title = BASE_TITLE;
    displayPanelContent('index');
  }
}


// This displays the element with the specified ID on the side panel and
// updates the navigation menu state as well.
function displayPanelContent(contentId) {
  document.querySelectorAll('.panel-content').forEach(function(content) {
    content.style.display = (content.id === contentId) ? content.dataset.display : 'none';
  });
  document.querySelectorAll('nav li').forEach(function(li) {
    if (li.childNodes[0].getAttribute('href') === '#' + contentId) {
      li.classList.add('selected');
    }
    else {
      li.classList.remove('selected');
    }
  });
}


// This toggles the sort mode and then sorts the index list.
function switchSortMode() {

  CurrentSortModeIdx = (CurrentSortModeIdx + 1) % SORT_MODES.length;
  document.getElementById('sort').innerHTML =
    'Sort list ' + SORT_MODES[(CurrentSortModeIdx + 1) % SORT_MODES.length].label;

  let sorter = function(getKey, compareKey) {
    return Object.keys(Markers)
      .map(function(el) {
        return { key: getKey(el), item: Markers[el].indexLi };
      })
      .sort(compareKey)
      .map(function(el) { return el.item });
  };

  let lis;
  if (SORT_MODES[CurrentSortModeIdx].id === 'alpha') {
    lis = sorter(
      function(el) { return Markers[el].indexTitle.replace(/^[^A-Za-z0-9]/, ''); },
      function(a, b) { return a.key > b.key ? 1 : -1; }
    );
  }
  else { // 'qid'
    lis = sorter(
      function(el) { return Number(el.substring(1)); },
      function(a, b) { return a.key - b.key; }
    );
  }

  let list = document.getElementById('marker-list');
  list.innerHTML = '';
  lis.forEach(function(li) { list.appendChild(li); });
}


// This takes a WDQS query result Wikidata item data and returns the
// item's QID.
function getQid(queryItem) {
  if (!queryItem) return '';
  return queryItem.value.split('/')[4];
}


// This takes a WDQS query result image data and returns the image filename.
function extractImageFilename(image) {
  let regex = /https?:\/\/commons\.wikimedia\.org\/wiki\/Special:FilePath\//;
  return unescape(image.value.replace(regex, ''));
}


// This takes an inscription text from Wikidata and reformats it into
// paragraphs.
function formatInscription(text) {
  return '<p>' + text.replace(/\s*<br\s*\/?>(?:<br\s*\/?>)?\s*/gi, '</p><p>') + '</p>';
}


// This takes a dictionary keyed by language code and an optional language code
// and returns the value for the code if it exists in the dictionary. Otherwise
// it returns the first value that matches an ordered list of language codes.
// Returns null if the dict is not valid and the empty string if there is no
// suitable language code existing in the dictionary.
function getTranslation(dict, langCode) {
  if (!dict) return null;
  if (langCode && langCode in dict) return dict[langCode];
  for (let i = 0; i < ORDERED_LANGUAGES.length; i++) {
    let langCode = ORDERED_LANGUAGES[i];
    if (langCode in dict) return dict[langCode];
  }
  return '';
}

// ------------------------------------------------------------

// Library function to load JSONP data
// Adapted from https://gist.github.com/gf3/132080/110d1b68d7328d7bfe7e36617f7df85679a08968
var loadJSONP = (function(){
  var unique = 0;
  return function(endpoint, params, callback) {

    // Create unique function name
    let name = '_jsonp_' + unique++;

    // Construct URL
    let queryParams = Object.keys(params).map(function(el) {
      return escape(el) + '=' + escape(params[el]);
    }).join('&');
    queryParams += queryParams ? '&' : '';
    queryParams += '&callback=' + name;

    // Create script element
    let script = document.createElement('script');
    script.type = 'text/javascript';
    script.src = endpoint + '?' + queryParams;

    // Setup handler
    window[name] = function(data) {
      callback.call(window, data);

      // Clean up
      script.remove();
      script = null;
      delete window[name];
    };

    // Load JSON
    document.getElementsByTagName('head')[0].appendChild(script);
  };
})();

// ------------------------------------------------------------

// Class declaration for representing a historical marker
function MarkerRecord() {
  this.indexTitle    = '';
  this.title         = {};  // empty if not encoded yet; null if novalue
  this.inscription   = {};  // empty if not encoded yet; null if novalue
  this.lat           = 0;
  this.lon           = 0;
  this.imageFilename = '';
  this.date          = '';
  this.datePrecision = YEAR_PRECISION;
  this.commemorates  = {};
  this.location      = { address:     '', imageFilename: '' };
  this.vicinity      = { description: '', imageFilename: '' };
  this.mapMarker     = undefined;
  this.popup         = undefined;
  this.panelElem     = undefined;
  this.indexLi       = undefined;
}

// ------------------------------------------------------------

init();

</script>
</body>
</html>
